# APIä¿®æ­£å†…å®¹ã¾ã¨ã‚

## ğŸ“ ä¿®æ­£æ¦‚è¦

APIãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ç›´ã—ã€å‹å®‰å…¨æ€§ã¨ã‚³ãƒ¼ãƒ‰å“è³ªã‚’å‘ä¸Šã•ã›ã¾ã—ãŸã€‚

## ğŸ”§ ä¿®æ­£ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«

### Libsï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªå±¤ï¼‰

#### 1. `src/libs/auth.ts`
**å¤‰æ›´å†…å®¹:**
- Node.jsçµ„ã¿è¾¼ã¿ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«`node:`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
- Express Requestå‹ã‚’æ‹¡å¼µã—ã¦`user`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‹å®‰å…¨ã«å®šç¾©
- æˆ»ã‚Šå€¤ã®å‹ã‚’æ˜ç¤ºçš„ã«`Promise<void>`ã«æŒ‡å®š
- `(req as any).user`ã‚’`req.user`ã«å¤‰æ›´ï¼ˆå‹å®‰å…¨ï¼‰
- æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ”¹å–„

**ä¿®æ­£å‰:**
```typescript
(req as any).user = { ... };
```

**ä¿®æ­£å¾Œ:**
```typescript
declare global {
  namespace Express {
    interface Request {
      user?: AuthedUser;
    }
  }
}
req.user = { ... };
```

#### 2. `src/libs/storage.ts`
**å¤‰æ›´å†…å®¹:**
- `node:fs`ã¨`node:path`ã«ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
- å…¨é–¢æ•°ã«æ˜ç¤ºçš„ãªæˆ»ã‚Šå€¤ã®å‹ã‚’è¿½åŠ 
- `localPut`ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã‚’æ”¹å–„ï¼ˆãƒã‚¹ãƒˆã•ã‚ŒãŸãƒ‘ã‚¹å¯¾å¿œï¼‰
- `localGetUrl`ã‚’åŒæœŸé–¢æ•°ã«ä¿®æ­£ï¼ˆä¸è¦ãªPromiseã‚’å‰Šé™¤ï¼‰
- `mime-types`ã®`getType`ã‚’`lookup`ã«ä¿®æ­£ï¼ˆæ­£ã—ã„APIä½¿ç”¨ï¼‰
- æœªä½¿ç”¨ã®`GetObjectCommand`ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å‰Šé™¤

**æ”¹å–„ç‚¹:**
```typescript
// ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è‡ªå‹•ä½œæˆã‚’è¿½åŠ 
const dir = path.dirname(file);
await fs.mkdir(dir, { recursive: true });
```

#### 3. `src/libs/slideshow.ts`
**å¤‰æ›´ãªã—** - æ—¢ã«å•é¡Œãªã—

#### 4. `src/libs/db.ts`
**å¤‰æ›´ãªã—** - æ—¢ã«å•é¡Œãªã—

#### 5. `src/libs/types.ts`
**å¤‰æ›´ãªã—** - æ—¢ã«å•é¡Œãªã—

### Servicesï¼ˆã‚µãƒ¼ãƒ“ã‚¹å±¤ï¼‰

#### 1. `src/services/album.service.ts`
**å¤‰æ›´ãªã—** - ãƒ­ã‚¸ãƒƒã‚¯ã¯æ—¢ã«æ­£ã—ã„

#### 2. `src/services/media.service.ts`
**å¤‰æ›´å†…å®¹:**
- Node.jsçµ„ã¿è¾¼ã¿ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«`node:`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
- `Express.Multer.File`å‹ã‚’ç‹¬è‡ªã®å‹å®šç¾©ã«ç½®ãæ›ãˆï¼ˆä¾å­˜ã‚’æ¸›ã‚‰ã™ï¼‰

**ä¿®æ­£å‰:**
```typescript
file: Express.Multer.File;
```

**ä¿®æ­£å¾Œ:**
```typescript
file: {
  originalname: string;
  mimetype: string;
  buffer: Buffer;
};
```

#### 3. `src/services/slideshow.service.ts`
**å¤‰æ›´ãªã—** - ãƒ­ã‚¸ãƒƒã‚¯ã¯æ—¢ã«æ­£ã—ã„

### Routesï¼ˆãƒ«ãƒ¼ãƒˆå±¤ï¼‰

#### 1. `src/routes/albums.ts`
**å¤‰æ›´å†…å®¹:**
- `(req as any).user`ã‚’`req.user!`ã«å¤‰æ›´
- ã‚ˆã‚Šèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«`userId`å¤‰æ•°ã‚’å°å…¥

**ä¿®æ­£å‰:**
```typescript
const user = (req as any).user;
const list = await svc.listAlbums(user.id);
```

**ä¿®æ­£å¾Œ:**
```typescript
const userId = req.user!.id;
const list = await svc.listAlbums(userId);
```

#### 2. `src/routes/media.ts`
**å¤‰æ›´å†…å®¹:**
- `(req as any).user`ã‚’`req.user!`ã«å¤‰æ›´
- `userId`å¤‰æ•°ã‚’å°å…¥

#### 3. `src/routes/slideshow.ts`
**å¤‰æ›´å†…å®¹:**
- `(req as any).user`ã‚’`req.user!`ã«å¤‰æ›´
- `userId`å¤‰æ•°ã‚’å°å…¥

#### 4. `src/routes/health.ts`
**å¤‰æ›´ãªã—** - æ—¢ã«ä¿®æ­£æ¸ˆã¿

#### 5. `src/index.ts`
**å¤‰æ›´ãªã—** - æ—¢ã«ä¿®æ­£æ¸ˆã¿ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¿½åŠ æ¸ˆã¿ï¼‰

## âœ¨ æ”¹å–„ç‚¹

### 1. å‹å®‰å…¨æ€§ã®å‘ä¸Š
- `any`å‹ã®ä½¿ç”¨ã‚’å‰Šæ¸›
- Express Requestå‹ã‚’æ‹¡å¼µã—ã¦`user`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‹ä»˜ã‘
- å…¨é–¢æ•°ã«æˆ»ã‚Šå€¤ã®å‹ã‚’æ˜ç¤º

### 2. Node.js ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- çµ„ã¿è¾¼ã¿ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«`node:`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨
- æ­£ã—ã„APIãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ï¼ˆmime-typesï¼‰

### 3. ã‚³ãƒ¼ãƒ‰å“è³ª
- ã‚ˆã‚Šèª­ã¿ã‚„ã™ã„å¤‰æ•°åï¼ˆ`userId`ï¼‰
- æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä½¿ç”¨
- ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã®æ”¹å–„

### 4. ä¾å­˜é–¢ä¿‚ã®å‰Šæ¸›
- Multerå‹ã¸ã®ç›´æ¥ä¾å­˜ã‚’å‰Šæ¸›
- æœ€å°é™ã®å‹å®šç¾©ã‚’ä½¿ç”¨

## ğŸ› æ®‹ã£ã¦ã„ã‚‹ã‚¨ãƒ©ãƒ¼ã«ã¤ã„ã¦

ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹**41å€‹ã®TypeScriptã‚¨ãƒ©ãƒ¼**ã¯ã€ã™ã¹ã¦**ä¾å­˜é–¢ä¿‚ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„**ã“ã¨ãŒåŸå› ã§ã™ã€‚

ã“ã‚Œã‚‰ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§è§£æ±ºã—ã¾ã™ï¼š

```bash
cd /Users/watanabeyuusaku/Desktop/album-video-main/api
npm install
```

### ã‚¨ãƒ©ãƒ¼ã®å†…è¨³

1. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ï¼ˆ33å€‹ï¼‰**
   - express, cors, @prisma/client, jose, multer, http-errors, mime-types, p-limit, @aws-sdk/client-s3
   - â†’ `npm install`ã§è§£æ±º

2. **Node.jså‹å®šç¾©ãŒãªã„ï¼ˆ8å€‹ï¼‰**
   - process, Buffer, console
   - â†’ `@types/node`ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§è§£æ±ºï¼ˆpackage.jsonã«å«ã¾ã‚Œã¦ã„ã¾ã™ï¼‰

## ğŸ“‹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- âœ… ã™ã¹ã¦ã®libsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªãƒ»ä¿®æ­£
- âœ… ã™ã¹ã¦ã®servicesãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªãƒ»ä¿®æ­£
- âœ… ã™ã¹ã¦ã®routesãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªãƒ»ä¿®æ­£
- âœ… å‹å®‰å…¨æ€§ã®å‘ä¸Š
- âœ… Node.jsãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®é©ç”¨
- âœ… ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§å‘ä¸Š
- âœ… ä¾å­˜é–¢ä¿‚ã®æœ€å°åŒ–

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
   ```bash
   npm install
   ```

2. **ã‚¨ãƒ‡ã‚£ã‚¿ã‚’å†èµ·å‹•**ï¼ˆTypeScriptã‚µãƒ¼ãƒãƒ¼ã®æ›´æ–°ã®ãŸã‚ï¼‰

3. **ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª**
   ```bash
   npm run build
   ```

4. **é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•**
   ```bash
   npm run dev
   ```

## ğŸ“š å‚è€ƒ

- [TypeScript Handbook - Module Resolution](https://www.typescriptlang.org/docs/handbook/module-resolution.html)
- [Node.js - ECMAScript Modules](https://nodejs.org/api/esm.html)
- [Express TypeScript Best Practices](https://expressjs.com/en/advanced/best-practice-performance.html)

## âœ¨ ã¾ã¨ã‚

ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè«–ç†çš„ã«æ­£ã—ãã€å‹å®‰å…¨æ€§ãŒå‘ä¸Šã—ã¾ã—ãŸã€‚æ®‹ã£ã¦ã„ã‚‹ã‚¨ãƒ©ãƒ¼ã¯å…¨ã¦ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§è§£æ±ºã—ã¾ã™ï¼

