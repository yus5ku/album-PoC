# ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ§‹é€ ã®è©³ç´°

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

### é–‹ç™ºç’°å¢ƒï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰

```
album-video-main/
â””â”€â”€ api/
    â”œâ”€â”€ .storage/                         # â† ã“ã“ã«å…¨ã¦ã®å†™çœŸãŒä¿å­˜ã•ã‚Œã‚‹
    â”‚   â”œâ”€â”€ album_clx001/                 # ã‚¢ãƒ«ãƒãƒ 1ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    â”‚   â”‚   â”œâ”€â”€ a1b2c3d4-...uuid....jpg   # å†™çœŸ1
    â”‚   â”‚   â”œâ”€â”€ e5f6g7h8-...uuid....png   # å†™çœŸ2
    â”‚   â”‚   â”œâ”€â”€ i9j0k1l2-...uuid....heic  # å†™çœŸ3
    â”‚   â”‚   â””â”€â”€ m3n4o5p6-...uuid....jpg   # å†™çœŸ4
    â”‚   â”‚
    â”‚   â”œâ”€â”€ album_clx002/                 # ã‚¢ãƒ«ãƒãƒ 2ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    â”‚   â”‚   â”œâ”€â”€ q7r8s9t0-...uuid....jpg
    â”‚   â”‚   â””â”€â”€ u1v2w3x4-...uuid....png
    â”‚   â”‚
    â”‚   â””â”€â”€ slideshows/                   # ç”Ÿæˆã•ã‚ŒãŸå‹•ç”»
    â”‚       â”œâ”€â”€ album_clx001/
    â”‚       â”‚   â””â”€â”€ job_abc123.mp4
    â”‚       â””â”€â”€ album_clx002/
    â”‚           â””â”€â”€ job_def456.mp4
    â”‚
    â”œâ”€â”€ src/
    â”œâ”€â”€ prisma/
    â””â”€â”€ package.json
```

### æœ¬ç•ªç’°å¢ƒï¼ˆS3ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰

```
s3://album-media-bucket/
â”œâ”€â”€ album_clx001/
â”‚   â”œâ”€â”€ a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg
â”‚   â”œâ”€â”€ e5f6g7h8-i9j0-1234-5678-90abcdef1234.png
â”‚   â””â”€â”€ i9j0k1l2-m3n4-5678-9012-3456789abcde.heic
â”œâ”€â”€ album_clx002/
â”‚   â”œâ”€â”€ q7r8s9t0-u1v2-3456-7890-abcdef123456.jpg
â”‚   â””â”€â”€ u1v2w3x4-y5z6-7890-1234-567890abcdef.png
â””â”€â”€ slideshows/
    â”œâ”€â”€ album_clx001/
    â”‚   â””â”€â”€ job_abc123.mp4
    â””â”€â”€ album_clx002/
        â””â”€â”€ job_def456.mp4
```

## ğŸ—‚ï¸ ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡

### ãƒ‘ã‚¿ãƒ¼ãƒ³

```
{albumId}/{uuid}{extension}
```

### ä¾‹

```
album_clx001/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg
â”‚           â”‚                                       â”‚
â”‚           â”‚                                       â””â”€ æ‹¡å¼µå­ï¼ˆå…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ï¼‰
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UUID v4ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚¢ãƒ«ãƒãƒ ID
```

### å…·ä½“ä¾‹

**ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«**: `family_photo.jpg`

**ä¿å­˜ã•ã‚Œã‚‹å ´æ‰€**:
- ãƒ­ãƒ¼ã‚«ãƒ«: `.storage/album_abc123/f1e2d3c4-b5a6-7890-1234-567890abcdef.jpg`
- S3: `s3://bucket/album_abc123/f1e2d3c4-b5a6-7890-1234-567890abcdef.jpg`

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²ã•ã‚Œã‚‹æƒ…å ±**:
```json
{
  "id": "media_xyz789",
  "albumId": "album_abc123",
  "storageKey": "local:album_abc123/f1e2d3c4-b5a6-7890-1234-567890abcdef.jpg",
  "mime": "image/jpeg",
  "caption": null,
  "tags": []
}
```

## ğŸ”„ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡
```typescript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
POST /media/upload
Content-Type: multipart/form-data

file: [binary data]
albumId: "album_abc123"
caption: "å®¶æ—å†™çœŸ"
tags: "family,2024"
```

### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
```typescript
// services/media.service.ts

const ext = path.extname(input.file.originalname);  // ".jpg"
const key = `${album.id}/${randomUUID()}${ext}`;
// â†’ "album_abc123/f1e2d3c4-b5a6-7890-1234-567890abcdef.jpg"
```

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
```typescript
// libs/storage.ts

const file = path.join(localDir, key);
// â†’ ".storage/album_abc123/f1e2d3c4-b5a6-7890-1234-567890abcdef.jpg"

const dir = path.dirname(file);
// â†’ ".storage/album_abc123"

await fs.mkdir(dir, { recursive: true });
// â†’ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã‘ã‚Œã°è‡ªå‹•ä½œæˆ
```

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿
```typescript
await fs.writeFile(file, buffer);
// â†’ ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
```

### ã‚¹ãƒ†ãƒƒãƒ—5: DBè¨˜éŒ²
```typescript
const media = await prisma.media.create({
  data: {
    albumId: "album_abc123",
    ownerId: "user_xyz",
    storageKey: "local:album_abc123/f1e2d3c4-...",
    mime: "image/jpeg",
    caption: "å®¶æ—å†™çœŸ",
    tags: ["family", "2024"]
  }
});
```

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®å¯¾å¿œ

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆMySQLï¼‰

| id | albumId | storageKey | mime | caption |
|----|---------|------------|------|---------|
| media_1 | album_001 | local:album_001/uuid1.jpg | image/jpeg | æµ·ã®å†™çœŸ |
| media_2 | album_001 | local:album_001/uuid2.png | image/png | å±±ã®å†™çœŸ |
| media_3 | album_002 | local:album_002/uuid3.jpg | image/jpeg | è¡—ã®å†™çœŸ |

### ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ 

```
.storage/
â”œâ”€â”€ album_001/
â”‚   â”œâ”€â”€ uuid1.jpg  â† media_1
â”‚   â””â”€â”€ uuid2.png  â† media_2
â””â”€â”€ album_002/
    â””â”€â”€ uuid3.jpg  â† media_3
```

## ğŸ¯ ãªãœã“ã®æ§‹é€ ãªã®ã‹ï¼Ÿ

### 1. ã‚¢ãƒ«ãƒãƒ ã”ã¨ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆ†ã‘ã‚‹ç†ç”±

âœ… **æ•´ç†ã—ã‚„ã™ã„**: ã‚¢ãƒ«ãƒãƒ å˜ä½ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†
âœ… **å‰Šé™¤ãŒç°¡å˜**: ã‚¢ãƒ«ãƒãƒ å‰Šé™¤æ™‚ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨å‰Šé™¤å¯èƒ½
âœ… **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå®¹æ˜“**: ã‚¢ãƒ«ãƒãƒ å˜ä½ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
âœ… **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: 1ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å¤§é‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¥ã‚Œãªã„

### 2. UUIDã‚’ä½¿ã†ç†ç”±

âœ… **è¡çªé˜²æ­¢**: åŒåãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚å•é¡Œãªã—
âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰å†…å®¹ã‚’æ¨æ¸¬ã§ããªã„
âœ… **URLå®‰å…¨**: ç‰¹æ®Šæ–‡å­—ã‚’å«ã¾ãªã„
âœ… **ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¸€æ„æ€§**: ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§ä¸€æ„

### 3. æ‹¡å¼µå­ã‚’ä¿æŒã™ã‚‹ç†ç”±

âœ… **ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—åˆ¤åˆ¥**: æ‹¡å¼µå­ã§ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥ãŒåˆ†ã‹ã‚‹
âœ… **äº’æ›æ€§**: ä»–ã®ãƒ„ãƒ¼ãƒ«ã§é–‹ãã‚„ã™ã„
âœ… **ãƒ‡ãƒãƒƒã‚°**: é–‹ç™ºæ™‚ã«å†…å®¹ãŒæ¨æ¸¬ã—ã‚„ã™ã„

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

### 1. ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒã®é˜²æ­¢

```typescript
// âŒ å±é™ºãªå®Ÿè£…ä¾‹
const key = req.body.filename;  // "../../../etc/passwd"
await fs.writeFile(key, buffer);  // ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãï¼

// âœ… å®‰å…¨ãªå®Ÿè£…ï¼ˆå®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ï¼‰
const key = `${album.id}/${randomUUID()}${ext}`;
// â†’ "album_001/uuid.jpg" ã®ã¿ï¼ˆ../ ã¯å«ã¾ã‚Œãªã„ï¼‰
```

### 2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™

```typescript
const upload = multer({ 
  limits: { fileSize: 50 * 1024 * 1024 }  // 50MBåˆ¶é™
});
```

### 3. MIME ã‚¿ã‚¤ãƒ—æ¤œè¨¼ï¼ˆä»Šå¾Œã®æ‹¡å¼µï¼‰

```typescript
// å®Ÿè£…ä¾‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ ï¼‰
const allowedTypes = ['image/jpeg', 'image/png', 'image/heic'];
if (!allowedTypes.includes(file.mimetype)) {
  throw createError(400, 'Invalid file type');
}
```

## ğŸ“ˆ å®¹é‡ç®¡ç†

### ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ã®ç¢ºèª

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ä½¿ç”¨é‡
du -sh api/.storage/

# ã‚¢ãƒ«ãƒãƒ ã”ã¨ã®ä½¿ç”¨é‡
du -sh api/.storage/*/
```

### ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```bash
# ç‰¹å®šã‚¢ãƒ«ãƒãƒ ã®ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
rm -rf api/.storage/album_xxx/

# å­¤ç«‹ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡ºï¼ˆDBã«è¨˜éŒ²ãŒãªã„ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
# â†’ å°‚ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆã‚’æ¨å¥¨
```

## ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆï¼ˆä»Šå¾Œã®æ‹¡å¼µï¼‰

```
.storage/
â””â”€â”€ album_001/
    â”œâ”€â”€ uuid1.jpg          # ã‚ªãƒªã‚¸ãƒŠãƒ«ï¼ˆ5MBï¼‰
    â”œâ”€â”€ uuid1_thumb.jpg    # ã‚µãƒ ãƒã‚¤ãƒ«ï¼ˆ100KBï¼‰
    â””â”€â”€ uuid1_medium.jpg   # ä¸­ã‚µã‚¤ã‚ºï¼ˆ500KBï¼‰
```

### 2. CDNé…ä¿¡ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

```
CloudFront CDN
    â†“
S3 Bucket
    â†“
ã‚ªãƒªã‚¸ãƒ³: album-media/album_001/uuid.jpg
```

## ğŸ“ ã¾ã¨ã‚

| é …ç›® | èª¬æ˜ |
|-----|------|
| **ä¿å­˜å ´æ‰€** | `.storage/` ã¾ãŸã¯ S3 |
| **ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª** | ã‚¢ãƒ«ãƒãƒ ã”ã¨ã«åˆ†é›¢ |
| **ãƒ•ã‚¡ã‚¤ãƒ«å** | UUID + æ‹¡å¼µå­ |
| **ç®¡ç†æ–¹æ³•** | DBã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®2å±¤ç®¡ç† |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** | UUIDã€ã‚µã‚¤ã‚ºåˆ¶é™ã€æ¨©é™ãƒã‚§ãƒƒã‚¯ |

ã“ã®æ§‹é€ ã«ã‚ˆã‚Šã€**å†™çœŸã¯å®‰å…¨ã«ã€æ•´ç†ã•ã‚ŒãŸçŠ¶æ…‹ã§ä¿å­˜**ã•ã‚Œã¾ã™ï¼

